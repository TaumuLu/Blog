---
title: 语言组织
date: 2018-08-09 14:45:55
tags: Record
---

## 语言
发表或提问前我都会在sublime上打出自己要说的语言，记录下来并反复阅读以重新组织语言达到自己的预期

### next提问
1. 为何要在dev模式下webpack加入WriteFilePlugin插件以生成文件，这样做是方便服务端require文件，但不能从内存中去读区吗，开发时从内存中读区文件速度更快不是吗，不然用webpack-hot-middleware只是为了做webpack的动态入口不浪费吗  
2. webpack为何要在开发模式下分别打两份包，重复打包增加编译时间，而且没有用CommonsChunkPlugin提取公共js，node打包模式不会打包node_modules，但web模式会为每一个单独的入口都打包进所有的文件且包括node_modules，这无疑增加了每次改动webpack的编译时间，随着页面、依赖的增多时间会更加长，开发体验会很差

我有一套方案且已实践，在开发模式下用生产模式的webpack打包，当然需要改动一些配置，只需要打包web环境的包，且以watch方式监听文件变动，路径保存在dist下，这样服务端渲染时还是引用这个路径的包，但要让服务端能正确require这个不是CommonJS规范的文件需要我们做一些hark，这里只要处理挂载到window上的webpackJsonp函数以及next提供的__NEXT_REGISTER_PAGE全局函数，以同样的方式我们挂载到global上，这样保证require时能正确处理，此外我们还要处理下__webpack_require__函数，以web方式打包会将node_modules里的包都打进来，这里有几个问题，有些包可能提供了node和browser环境下的不同包，比如superagent，还有些包不允许引用多次，比如babel-polyfill，所以我们需要在__webpack_require__这个函数上做点手脚，针对以上问题的包忽略或者从路径提取出包名直接require引用，可能有些包还有其他问题不过理论上在__webpack_require__这里都能处理掉  

其他问题  
开发模式下提供监听改动实时打包，在客户端下没有问题，但在服务端有问题，由于node会缓存require的包导致文件变动也不会再次require源文件，这里用delete require.cache\[path\]的方式删除引用过的包，但并未结束由于用webpack打包，webpack会用一个变量installedModules来缓存所有引用过的包，所以我们还需要清除webpack的缓存，这一点方法很多，通过导出函数来清理即可

最终  
至此问题已基本解决，再处理下next的资源文件请求即可，这里可以自行处理，资源文件最好尽快处理，减少无关中间件的执行


### RN回答
刚好之前的项目是用RN做的，就说下我遇到的坑和理解吧  
先说RN对原生这块，虽然RN是用前端最熟悉的react来写的，但如其他的回答，如果不懂原生还是很难做好的，不然从打包发布这块就会被卡住，如果需要原生的支持，Xcode的使用也要了解  

再说RN自身的组件，对android的支持做的就不如ios好，很多组件官方只提供了ios的api，Android还未完善，导致两端预期不一致，这并不是我们想看到的，尤其对两端统一的需求来说  
